name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    name: Test Python ${{ matrix.python-version }} / PyTorch ${{ matrix.pytorch-version }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]
        pytorch-version: ["2.0", "2.1", "2.2", "2.3"]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v5
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: Install PyTorch ${{ matrix.pytorch-version }}
      run: |
        if [ "${{ matrix.pytorch-version }}" == "2.0" ]; then
          pip install torch==2.0.1
        elif [ "${{ matrix.pytorch-version }}" == "2.1" ]; then
          pip install torch==2.1.2
        elif [ "${{ matrix.pytorch-version }}" == "2.2" ]; then
          pip install torch==2.2.2
        elif [ "${{ matrix.pytorch-version }}" == "2.3" ]; then
          pip install torch==2.3.1
        fi

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        # Install all dependencies except torch (already installed)
        pip install einops==0.7.0
        pip install lightning==2.2.0
        pip install scipy==1.11.4
        pip install loguru==0.7.2
        pip install rich==13.7.0
        # Install dev dependencies
        pip install pytest==7.4.4
        pip install pytest-cov==4.1.0
        pip install ruff==0.1.14
        pip install black==23.12.1

    - name: Lint with ruff
      run: |
        ruff check neuromanifold_gpt/ --select E,F,W
      continue-on-error: true

    - name: Check formatting with black
      run: |
        black --check neuromanifold_gpt/
      continue-on-error: true

    - name: Run tests with pytest
      run: |
        pytest neuromanifold_gpt/tests/ -v --tb=short

    - name: Run tests with coverage
      if: matrix.python-version == '3.11' && matrix.pytorch-version == '2.2'
      run: |
        pytest neuromanifold_gpt/tests/ --cov=neuromanifold_gpt --cov-report=xml --cov-report=term

    - name: Upload coverage to artifacts
      if: matrix.python-version == '3.11' && matrix.pytorch-version == '2.2'
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage.xml

  lint:
    name: Lint and Format Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install linting tools
      run: |
        python -m pip install --upgrade pip
        pip install ruff==0.1.14
        pip install black==23.12.1

    - name: Lint with ruff
      run: |
        ruff check neuromanifold_gpt/ --select E,F,W,I,N

    - name: Check formatting with black
      run: |
        black --check neuromanifold_gpt/

  dependency-check:
    name: Dependency Resolution Check
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Check requirements.txt resolution
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt --dry-run

    - name: Check requirements-dev.txt resolution
      run: |
        pip install -r requirements-dev.txt --dry-run

    - name: Verify pinned versions
      run: |
        echo "Checking that all dependencies are pinned with =="
        if grep -E "^[a-zA-Z0-9_-]+[><=!]" requirements.txt | grep -v "=="; then
          echo "Error: Found unpinned dependencies in requirements.txt"
          exit 1
        fi
        if grep -E "^[a-zA-Z0-9_-]+[><=!]" requirements-dev.txt | grep -v "==" | grep -v "^-r"; then
          echo "Error: Found unpinned dependencies in requirements-dev.txt"
          exit 1
        fi
        echo "All dependencies are properly pinned!"

  config-compatibility:
    name: Configuration System Compatibility Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v5
      with:
        python-version: "3.11"
        cache: 'pip'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install torch==2.2.2
        pip install einops==0.7.0
        pip install lightning==2.2.0
        pip install scipy==1.11.4
        pip install loguru==0.7.2
        pip install rich==13.7.0
        pip install pytest==7.4.4

    - name: Test new type-safe config system
      run: |
        echo "Testing type-safe config loader..."
        python -c "from neuromanifold_gpt.config.loader import load_config; print('✓ Config loader imports successfully')"
        python -c "from neuromanifold_gpt.config.presets import get_nano_config; c = get_nano_config(); print('✓ Nano preset loaded: n_layer=' + str(c.n_layer))"
        python -c "from neuromanifold_gpt.config.presets import get_small_config, get_medium_config, get_reasoning_config; print('✓ All presets importable')"

    - name: Test backward compatibility layer
      run: |
        echo "Testing backward compatibility shim..."
        python -c "from neuromanifold_gpt.config.compat import apply_config_overrides; print('✓ Compatibility layer imports successfully')"
        python -c "
        from neuromanifold_gpt.config.compat import apply_config_overrides
        import warnings
        c = {'batch_size': 16, 'learning_rate': 1e-3}
        with warnings.catch_warnings(record=True) as w:
            warnings.simplefilter('always')
            result = apply_config_overrides(c, ['--batch_size=32'])
            assert result['batch_size'] == 32
            assert len(w) > 0  # Deprecation warning should be issued
        print('✓ Backward compatibility layer works with deprecation warnings')
        "

    - name: Test migrated scripts work
      run: |
        echo "Testing migrated scripts..."
        python eval.py --help > /tmp/eval_help.txt
        if grep -q "Type-Safe Configuration Loader" /tmp/eval_help.txt; then
          echo "✓ eval.py uses type-safe config loader"
        else
          echo "✗ eval.py does not show type-safe config help"
          exit 1
        fi

        python examples/train_with_component_metrics.py --help > /tmp/train_help.txt
        if grep -q "Configuration" /tmp/train_help.txt; then
          echo "✓ train_with_component_metrics.py uses type-safe config loader"
        else
          echo "✗ train_with_component_metrics.py does not show config help"
          exit 1
        fi

    - name: Run config-specific tests
      run: |
        echo "Running comprehensive config loader tests..."
        pytest neuromanifold_gpt/tests/test_config_loader.py -v --tb=short -k "test_load_config or test_preset or test_compat or test_backward"

    - name: Test CLI override patterns (new system)
      run: |
        echo "Testing new config system with CLI overrides..."
        python -c "
        from neuromanifold_gpt.config.loader import load_config
        from neuromanifold_gpt.config.training import TrainingConfig

        # Test override with CLI args
        c = load_config(TrainingConfig, ['--batch_size=64', '--learning_rate=0.001'], show_help=False)
        assert c.batch_size == 64
        assert c.learning_rate == 0.001
        print('✓ CLI overrides work in new system')
        "

    - name: Verify legacy config files exist with warnings
      run: |
        echo "Verifying legacy config directory has deprecation notice..."
        if [ -f "config/legacy/README.md" ]; then
          if grep -q "DEPRECATED" config/legacy/README.md; then
            echo "✓ Legacy config directory has deprecation warning"
          else
            echo "⚠ Legacy config directory exists but lacks deprecation warning"
            exit 1
          fi
        else
          echo "⚠ Legacy config directory README not found"
          exit 1
        fi

    - name: Test migration path documentation
      run: |
        echo "Verifying migration documentation exists..."
        if [ -f "docs/config-migration-guide.md" ]; then
          echo "✓ Migration guide exists"
          if grep -q "load_config" docs/config-migration-guide.md; then
            echo "✓ Migration guide documents new load_config() API"
          else
            echo "✗ Migration guide missing load_config() documentation"
            exit 1
          fi
        else
          echo "✗ Migration guide not found"
          exit 1
        fi

    - name: Full config loader test suite
      run: |
        echo "Running full config loader test suite..."
        pytest neuromanifold_gpt/tests/test_config_loader.py -v --tb=short
